<?php
class materials extends Axapta {
	/*
	 *  Materials
	 *
	 *	Options: 
	 *	Defaults: 
	 *
	 */
	function get() {
		if ( $this->conn  ) {
			$materials = $this->conn->query(
				"SELECT 
					INVENTTABLE.ITEMID                      AS item_id,
					LTRIM(PRICEDISCTABLE.INVENTDIMID)       AS dimension_id,
					PRICEDISCTABLE.RTDITEMNAME              AS itemName,
					CONFIGTABLE.NAME                        AS name,
					PRICEDISCTABLE.UNITID                   AS unit,
					PRICEDISCTABLE.RTDPRICETYPE             AS priceType,
					PRICEDISCTABLE.AMOUNT                   AS ammount,
					RTDCONTRACT.VALIDFROM                   AS validFrom,
					RTDCONTRACT.VALIDTO                     AS valitTo
				FROM PROJTABLE
					JOIN SALESTABLE      ON PROJTABLE.PROJID = SALESTABLE.projID AND PROJTABLE.DATAAREAID = SALESTABLE.DATAAREAID
					JOIN PRICEDISCTABLE  ON LTRIM(RTRIM(SALESTABLE.PriceGroupID)) = LTRIM(RTRIM(PRICEDISCTABLE.AccountRelation)) AND PROJTABLE.DATAAREAID = PRICEDISCTABLE.DATAAREAID
					JOIN RTDCONTRACT     ON RTDCONTRACT.CONTRACTID = LTRIM(RTRIM(SALESTABLE.PriceGroupID)) AND PROJTABLE.DATAAREAID = RTDCONTRACT.DATAAREAID
					JOIN INVENTTABLE     ON PRICEDISCTABLE.ITEMRELATION = INVENTTABLE.ITEMID AND PROJTABLE.DATAAREAID = INVENTTABLE.DATAAREAID
					JOIN INVENTDIM       ON INVENTDIM.INVENTDIMID = PRICEDISCTABLE.INVENTDIMID AND PROJTABLE.DATAAREAID = INVENTDIM.DATAAREAID
					JOIN CONFIGTABLE     ON CONFIGTABLE.CONFIGID = INVENTDIM.CONFIGID AND CONFIGTABLE.ITEMID = INVENTTABLE.ITEMID AND PROJTABLE.DATAAREAID = CONFIGTABLE.DATAAREAID
				WHERE
					RTDCONTRACT.VALID = 1
					AND SALESTABLE.PROJID = REPLACE('$projid', '-', '/')
					AND INVENTTABLE.RTDFILMIND = '1'
				ORDER BY PRICEDISCTABLE.RTDITEMNAME"
			);
			
			return $materials->fetchAll();
		} else {
			return FALSE;
		}
	}
}